[![Imports: isort](https://img.shields.io/badge/%20imports-isort-%231674b1?style=flat&labelColor=ef8336)](https://pycqa.github.io/isort/)
[![Checked with mypy](http://www.mypy-lang.org/static/mypy_badge.svg)](http://mypy-lang.org/)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)
[![codecov](https://codecov.io/gh/boxfishdev/riziki-bend/branch/develop/graph/badge.svg?token=M3GL6Q1Z2Z)](https://codecov.io/gh/boxfishdev/riziki-bend)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

# Biomed_system


## Table of Contents

- [Requirements](#requirements)
- [Local Development](#local-development)
  - [Env Setup](#env-setup)
    - [Environment Variables](#environment-variables)
  - [Project Setup](#project-setup)
    - [Docker Setup](#docker-setup)
    - [Manual Setup](#manual-setup)
  - [Running the app](#running-the-app)

## Requirements

- [Python](https://www.python.org/downloads/) >= 3.10
- [Redis](https://redis.io/download/)
- [pipenv](https://pipenv.pypa.io/en/latest/#install-pipenv-today)

## Local Development

### Env Setup

1. Clone the repository:\
    a. Using SSH:

   ```
   git clone git@github.com:EdwinAtieno/biomed_sys.git
   ```

   b. Using Http:

   ```
   git https://github.com/EdwinAtieno/biomed_sys.git
   ```

2. Navigate to the cloned folder:

   ```
   cd biomed_sys
   ```

3. In order to create a virtual environment, run:

   ```
   pipenv shell
   ```

   - It will also create Pipfile and Pipfile.lock for package requirements.

4. So as to install the packages in your environment, run:

   ```
   pipenv install
   ```

   - In order to install all packages(including dev packages), run:
     ```
     pipenv install --dev
     ```

5. To install the pre-commit git hooks, run:

   ```
   pre-commit install
   ```

6. Create a .env file
   ```
   touch .env
   ```
   - Add the following environment variables in your `.env` file

#### Environment Variables

| Variable                        | Description                                                                                                                                                                                                                                                                          | Default          |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------- |
| <sup>**SECRET_KEY**</sup>       | <sup>**Required** - String of random characters used to provide cryptographic signing for [Django](https://docs.djangoproject.com/en/2.1/ref/settings/#std:setting-SECRET_KEY) projects.</sup>                                                                                       | <sup></sup>      |
| <sup>**DATABASE_URL**</sup>     | <sup>**Required** - Used by [dj_database_url](https://github.com/kennethreitz/dj-database-url#url-schema) to connect to the database.<br /> Format: postgresql://\<user\>:\<password\>@\<host\>:\<port\>/\<db\>. <br/>If using docker, put the host as: `host.docker.internal`</sup> | <sup></sup>      |
| <sup>**ENVIRONMENT**</sup>      | <sup> **Optional** - Used to load different settings according to the environment selected. Choices: `production`, `staging`, `local`</sup>                                                                                                                                          | <sup>local</sup> |
| <sup>**REDIS_URL**</sup>        | <sup> **Required** - Used to store messages produced by the application code describing the work to be done in the Celery task queue. .<br /> Format: redis://:\<password\>@\<host\>:\<port\></sup>                                                                                  | <sup></sup>      |
| <sup>**ONFON_API_KEY**</sup>    | <sup> **Required** - Used to authenticate access to Onfon Media services. [Onfon API Docs](https://sms.onfonmedia.co.ke/ApiDocument/ApiDocs)</sup>                                                                                                                                   | <sup></sup>      |
| <sup>**ONFON_CLIENT_ID**</sup>  | <sup> **Required** - Client ID is a unique identifier generated by Onfon Media. [Onfon API Docs](https://sms.onfonmedia.co.ke/ApiDocument/ApiDocs)</sup>                                                                                                                             | <sup></sup>      |
| <sup>**ONFON_ACCESS_KEY**</sup> | <sup> **Required** - Inorder to access any API on Onfon Media a user requires to send an access key with the header for all API requests</sup>                                                                                                                                       | <sup></sup>      |
| <sup>**ONFON_SENDER_ID**</sup>  | <sup> **Required** - Business short code provided by Onfon Media that will be used to send sms. [https://sms.onfonmedia.co.ke/Management/ManageSenderID](https://sms.onfonmedia.co.ke/Management/ManageSenderID)</sup>                                                               | <sup></sup>      |
| <sup>**CLOUDINARY_CLOUD_NAME**</sup>  | <sup> **Required** - required by [https://cloudinary.com](https://cloudinary.com) to identify the cloud name</sup>                                                               | <sup></sup>      |
| <sup>**CLOUDINARY_API_KEY**</sup>  | <sup> **Required** - provided by [https://cloudinary.com](https://cloudinary.com) to uniquely identify the client </sup>                                                               | <sup></sup>      |
| <sup>**CLOUDINARY_API_SECRET**</sup>  | <sup> **Required** - provided by [https://cloudinary.com](https://cloudinary.com) to authenticate in conjuction with the CLOUDINARY_API_KEY </sup>                                                               | <sup></sup>      |

### Project Setup

#### Docker Setup

- To install Docker: [https://docs.docker.com/get-docker/](https://docs.docker.com/get-docker/)

- To install Docker Compose: [https://docs.docker.com/compose/install/](https://docs.docker.com/compose/install/)

- Add `POSTGRES_USER`, `POSTGRES_PASSWORD` and `POSTGRES_DB` environment variables to your `.env` file. And change the `DATABASE_URL` host to `host.docker.internal`

- Put the `REDIS_URL` as [redis://redis:6379](redis://redis:6379)

- Build the Docker images:

  ```
  docker-compose build
  ```

- Run the Docker images in detached mode(in the background) remove the `-d` flag from the command.
  if you want to see the output or attach to the container:

  ```
  docker-compose up -d
  ```

- To run individual containers:

  ```
  docker-compose run <container_name>
  ```

- To stop the containers:

  ```
  docker-compose stop
  ```

#### Manual Setup

- Create a database and add its url to your project environment. eg <br/>
  `DATABASE_URL=postgresql://<user>:<password>@<host>:<port>/<db>`

- Run Redis Server and add its url to your project environment: eg <br/>
  `REDIS_URL=redis://:<password>@<host>:<port>`

- Create and activate a virtual environment - we recommend using [pipenv](https://github.com/pypa/pipenv) for this by running:
  ```
  pipenv shell
  ```
- Install the project dependencies stored in [Pipfile](/Pipfile). Run:
  ```
  pipenv install --dev
  ```
- Run migrations:
  ```
  python manage.py migrate
  ```

### Running the app

- To run tests:

  ```
  pytest
  ```

- Make Sure that Redis is installed on your machine.(if you will run redis locally). Then run:

  ```
  redis-server
  ```

  - NB: store the url of your redis server in the .env

* For the celery worker:

  - To start the celery worker

    ```
    celery -A riziki worker -l info
    ```

  - To view messages/ tasks in the queue:

    ```
    celery -A riziki flower worker -l info
    ```

  - In order, to remove all tasks from celery:

    ```
    celery -A  riziki purge
    ```

* Run the app:

  ```
  python manage.py runserver
  ```

* You can now use the app locally using the URL: [http://127.0.0.1:8000/](http://127.0.0.1:8000/)
